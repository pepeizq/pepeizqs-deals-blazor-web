﻿@using Juegos

@if (capturas?.Count > 0)
{
    bool difuminar = false;

    if (string.IsNullOrEmpty(usuarioId) == true)
    {
        if (string.IsNullOrEmpty(mayorEdad) == false)
        {
            if (mayorEdad.ToLower() == "true")
            {
                difuminar = true;
            }
        }

        if (mediaMostrarPosicion < 99999)
        {
            if (capturas[mediaMostrarPosicion]?.MayorEdad == true)
            {
                difuminar = true;
            }
        }
    }

    <div class="juego-galeria-contenedor">
        @if ((mediaMostrarPosicion >= 99999 && mediaMostrarPosicion <= 100003) && difuminar == false)
        {
            <video style="width: 100%; height: calc(100vh - 190px); cursor: pointer; background-image: url('@mediaMostrarCaptura'); background-size: cover; background-position: center;" controls="controls" preload="none" @onplay="EjecutarVideo">
                <source src="@mediaMostrar" type="@mediaMostrarTipo" />
            </video>
        }
        else
        {
            <div style="overflow: hidden;">
                <div class="juego-galeria-numero">@(mediaMostrarPosicion + 1) / @(capturas.Count)</div>

                @if (difuminar == false)
                {
                    <img src="@mediaMostrar" style="width: 100%; height: calc(100vh - 190px); object-fit: contain;" alt="@nombre">
                }
                else
                {
                    <img src="@mediaMostrar" style="width: 100%; height: calc(100vh - 190px); object-fit: contain; filter: blur(10px);" alt="@nombre">
                }
            </div>

            <a class="juego-galeria-atras" @onclick="@(e => CambiarMediaMostrar(e, mediaMostrarPosicion - 1))">&#10094;</a>
            <a class="juego-galeria-siguiente" @onclick="@(e => CambiarMediaMostrar(e, mediaMostrarPosicion + 1))">&#10095;</a>
        }

        <div class="juego-galeria-fila" style="scrollbar-color: var(--fondoCodigo) var(--fondoOscuro);">
            @{
                if (videos?.Count > 0)
                {
                    for (int j = 99999; j < videos.Count + 99999; j += 1)
                    {
                        int videoPosicion = j - 99999;
                        string capturaVideo = videos[videoPosicion].CapturaPequeña;

                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, videoPosicion + 99999))" style="position: relative;">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaVideo, 232, 130)" style="width: 100%;" alt="@videos[videoPosicion].Nombre">

                            <div style="max-width: 42px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <svg class="svg-boton" style="cursor: pointer;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                    <path d="M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9l0 176c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z" />
                                </svg>
                            </div>
                        </div>
                    }
                }

                int i = 0;
                while (i < capturas.Count)
                {
                    int nuevaPosicion = i;
                    string capturaMiniatura = capturas[i].Imagen.Replace(".jpg", ".600x338.jpg");
                    bool difuminarMiniatura = false;

                    if (string.IsNullOrEmpty(usuarioId) == true)
                    {
                        if (string.IsNullOrEmpty(mayorEdad) == false)
                        {
                            if (mayorEdad.ToLower() == "true")
                            {
                                difuminarMiniatura = true;
                            }
                        }

                        if (capturas[i].MayorEdad == true)
                        {
                            difuminarMiniatura = true;
                        }
                    }

                    if (difuminarMiniatura == false)
                    {
                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, nuevaPosicion))">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaMiniatura, 220, 124)" style="width: 100%;" alt="@nombre">
                        </div>
                    }
                    else
                    {
                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, nuevaPosicion))" style="overflow: hidden;">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaMiniatura, 220, 124)" style="width: 100%; filter: blur(10px);" alt="@nombre">
                        </div>
                    }

                    i += 1;
                }
            }
        </div>
    </div>
}

@code {

    #nullable disable

    [Parameter]
    public string usuarioId { get; set; }

    [Parameter]
    public string mayorEdad { get; set; }

    [Parameter]
    public string nombre { get; set; }

    [Parameter]
    public List<JuegoMediaCaptura> capturas { get; set; }

    [Parameter]
    public List<JuegoMediaVideo> videos { get; set; }

    protected override void OnInitialized()
    {
        if (videos?.Count > 0)
        {
            bool cargar = true;

            if (string.IsNullOrEmpty(usuarioId) == true)
            {
                if (string.IsNullOrEmpty(mayorEdad) == false)
                {
                    if (mayorEdad.ToLower() == "true")
                    {
                        cargar = false;
                    }
                }

                if (videos[0].MayorEdad == true)
                {
                    cargar = false;
                }
            }

            if (cargar == true)
            {
                mediaMostrar = videos[0].Enlace;
                mediaMostrarCaptura = videos[0].Captura;
                mediaMostrar = mediaMostrar.Replace("http://", "https://");
                mediaMostrarCaptura = mediaMostrarCaptura.Replace("http://", "https://");
                mediaMostrarPosicion = 99999;

                if (string.IsNullOrEmpty(mediaMostrar) == false)
                {
                    if (mediaMostrar.EndsWith(".mp4") == true)
                    {
                        mediaMostrarTipo = "video/mp4";
                    }
                    else if (mediaMostrar.EndsWith(".webm") == true)
                    {
                        mediaMostrarTipo = "video/webm";
                    }
                    else if (mediaMostrar.EndsWith(".m3u8") == true)
                    {
                        mediaMostrarTipo = "application/x-mpegURL";
                    }
                }
            }
        }

        if (mediaMostrarPosicion == 0)
        {
            if (capturas?.Count > 0)
            {
                mediaMostrar = capturas[0].Imagen;
                mediaMostrarPosicion = 1;
            }
        }
    }

    private int mediaMostrarPosicion = 0;
    private string mediaMostrar = string.Empty;
    private string mediaMostrarTipo = string.Empty;
    private string mediaMostrarCaptura = string.Empty;

    private void CambiarMediaMostrar(MouseEventArgs e, int nuevaCaptura)
    {
        if (nuevaCaptura == 99999)
        {
            mediaMostrar = videos[0].Enlace;
            mediaMostrarCaptura = videos[0].Captura;
        }
        else if (nuevaCaptura == 100000)
        {
            mediaMostrar = videos[1].Enlace;
            mediaMostrarCaptura = videos[1].Captura;
        }
        else if (nuevaCaptura == 100001)
        {
            mediaMostrar = videos[2].Enlace;
            mediaMostrarCaptura = videos[2].Captura;
        }
        else if (nuevaCaptura == 100002)
        {
            mediaMostrar = videos[3].Enlace;
            mediaMostrarCaptura = videos[3].Captura;
        }
        else if (nuevaCaptura == 100003)
        {
            mediaMostrar = videos[4].Enlace;
            mediaMostrarCaptura = videos[4].Captura;
        }
        else if (nuevaCaptura < 99999)
        {
            if (nuevaCaptura < 0)
            {
                nuevaCaptura = capturas.Count - 1;
            }
            else if (nuevaCaptura >= capturas.Count && nuevaCaptura < 99999)
            {
                nuevaCaptura = 0;
            }

            if (nuevaCaptura >= 0 && nuevaCaptura < capturas.Count)
            {
                mediaMostrar = capturas[nuevaCaptura].Imagen;
            }
        }

        mediaMostrar = mediaMostrar?.Replace("http://", "https://");
        mediaMostrarCaptura = mediaMostrarCaptura?.Replace("http://", "https://");
        mediaMostrarPosicion = nuevaCaptura;

        if (string.IsNullOrEmpty(mediaMostrar) == false)
        {
            if (mediaMostrar.EndsWith(".mp4") == true)
            {
                mediaMostrarTipo = "video/mp4";
            }
            else if (mediaMostrar.EndsWith(".webm") == true)
            {
                mediaMostrarTipo = "video/webm";
            }
            else if (mediaMostrar.EndsWith(".m3u8") == true)
            {
                mediaMostrarTipo = "application/x-mpegURL";
            }
        }
    }

    private void EjecutarVideo()
    {
        mediaMostrarCaptura = null;
    }
}