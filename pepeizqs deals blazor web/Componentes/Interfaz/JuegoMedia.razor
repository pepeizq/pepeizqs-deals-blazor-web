﻿@using Juegos

@inject IJSRuntime JavaScript

<style>
    .pepe-video-contenedor {
        width: fit-content;
        height: fit-content;
        margin-bottom: 20px;
        background: #141414;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0,0,0,0.7);
        position: relative;
    }

    #reproductor {
        width: 100%;
        display: block;
        background: black;
        cursor: pointer;
    }

    .video-controles {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .pepe-video-contenedor:hover .video-controles {
        opacity: 1;
    }

    .controles-fila {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .control-boton {
        background: var(--fondoBotonPequeño);
        box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.28),0px 0px 1px 0px rgba(0, 0, 0, 0.24);
        border: none;
        color: var(--colorTexto);
        padding: 6px 10px;
        margin-right: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

        .control-boton:hover {
            background: var(--fondoCodigo);
        }

    .volumen-deslizador {
        width: 100px;
    }

    .progreso-contenedor {
        width: 100%;
        background: rgba(255,255,255,0.2);
        height: 6px;
        border-radius: 3px;
        margin-bottom: 6px;
        cursor: pointer;
        position: relative;
    }

    .progreso-barra {
        height: 100%;
        background: var(--fondoCodigo);
        width: 0%;
        border-radius: 3px;
    }

    .tiempo-mensaje {
        color: var(--colorTexto);
        font-size: 0.85rem;
        margin-left: 5px;
    }
</style>

<script>
    window.hlsPlayer = {
        loadStream: function (url) {
            const video = document.getElementById("reproductor");
            video.pause();

            if (window.hls) {
                window.hls.destroy();
                window.hls = null;
            }

            video.removeAttribute("src");
            video.load();

            const lowerUrl = url.toLowerCase();

            if (lowerUrl.endsWith(".m3u8")) {
                if (Hls.isSupported()) {
                    window.hls = new Hls();
                    window.hls.loadSource(url);
                    window.hls.attachMedia(video);
                    video.play();
                } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                    video.src = url;
                    video.play();
                }
            }

            if (lowerUrl.endsWith(".mp4") || lowerUrl.endsWith(".webm")) {
                video.src = url;
                video.load();
                video.play();
            }
        },

        togglePlay: function(video) {
            if (video.paused) {
                video.play();
                return true;
            } else {
                video.pause();
                return false;
            }
        },

        toggleMute: function(video) {
            video.muted = !video.muted;
            return video.muted;
        },

        setVolume: function(video, vol) {
            video.volume = vol;
        },

        toggleFullScreen: function() {
            const video = document.getElementById("reproductor");

            if (!document.fullscreenElement) {
                video.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        },

        registerTimeUpdate: function(dotNetHelper) {
            const video = document.getElementById("reproductor");

            video.addEventListener("timeupdate", function() {
                dotNetHelper.invokeMethodAsync("UpdateTime", video.currentTime, video.duration);
            });
        },

        seek: function(clientX) {
            const video = document.getElementById("reproductor");
            const rect = video.getBoundingClientRect();
            const percent = (clientX - rect.left) / rect.width;
            video.currentTime = video.duration * percent;
        }
    };
</script>

@if (capturas?.Count > 0)
{
    bool difuminar = false;

    if (string.IsNullOrEmpty(usuarioId) == true)
    {
        if (string.IsNullOrEmpty(mayorEdad) == false)
        {
            if (mayorEdad.ToLower() == "true")
            {
                difuminar = true;
            }
        }

        if (mediaMostrarPosicion < 99999)
        {
            if (capturas[mediaMostrarPosicion]?.MayorEdad == true)
            {
                difuminar = true;
            }
        }
    }

    <div class="juego-galeria-contenedor">
        @if ((mediaMostrarPosicion >= 99999 && mediaMostrarPosicion <= 100003) && difuminar == false)
        {
            <div style="display: flex; justify-items: center; justify-content: center;" @onclick="TogglePlay">
                <div class="pepe-video-contenedor">
                    <video id="reproductor" style="width: 100%; height: calc(100vh - 190px);" @ref="videoRef" @onplay="EjecutarVideo">
                        <source src="@mediaMostrar" type="@mediaMostrarTipo" />
                    </video>

                    <div class="video-controles">
                        <div class="progreso-contenedor" @onclick="Seek">
                            <div class="progreso-barra" style="width:@ProgressPercent%;"></div>
                        </div>

                        <div class="controles-fila">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="control-boton" @onclick="TogglePlay">@((isPlaying ? "Pause" : "Play"))</button>
                                <button class="control-boton" @onclick="ToggleMute">@((isMuted ? "Unmute" : "Mute"))</button>
                                <input type="range" class="volumen-deslizador" min="0" max="1" step="0.05" @bind="volume" @oninput="ChangeVolume" />
                            </div>
                            <div class="tiempo-mensaje">@TimeDisplay</div>
                            <button class="control-boton" @onclick="ToggleFullScreen">
                                <div style="display: flex; width: 20px; height: 20px;">
                                    <svg style="fill: var(--colorTexto);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                        <path d="M408 64L552 64C565.3 64 576 74.7 576 88L576 232C576 241.7 570.2 250.5 561.2 254.2C552.2 257.9 541.9 255.9 535 249L496 210L409 297C399.6 306.4 384.4 306.4 375.1 297L343.1 265C333.7 255.6 333.7 240.4 343.1 231.1L430.1 144.1L391.1 105.1C384.2 98.2 382.2 87.9 385.9 78.9C389.6 69.9 398.3 64 408 64zM232 576L88 576C74.7 576 64 565.3 64 552L64 408C64 398.3 69.8 389.5 78.8 385.8C87.8 382.1 98.1 384.2 105 391L144 430L231 343C240.4 333.6 255.6 333.6 264.9 343L296.9 375C306.3 384.4 306.3 399.6 296.9 408.9L209.9 495.9L248.9 534.9C255.8 541.8 257.8 552.1 254.1 561.1C250.4 570.1 241.7 576 232 576z" />
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div style="overflow: hidden;">
                <div class="juego-galeria-numero">@(mediaMostrarPosicion + 1) / @(capturas.Count)</div>

                @if (difuminar == false)
                {
                    <img src="@mediaMostrar" style="width: 100%; height: calc(100vh - 190px); object-fit: contain;" alt="@nombre">
                }
                else
                {
                    <img src="@mediaMostrar" style="width: 100%; height: calc(100vh - 190px); object-fit: contain; filter: blur(10px);" alt="@nombre">
                }
            </div>

            <a class="juego-galeria-atras" @onclick="@(e => CambiarMediaMostrar(e, mediaMostrarPosicion - 1))">&#10094;</a>
            <a class="juego-galeria-siguiente" @onclick="@(e => CambiarMediaMostrar(e, mediaMostrarPosicion + 1))">&#10095;</a>
        }

        <div class="juego-galeria-fila" style="scrollbar-color: var(--fondoCodigo) var(--fondoOscuro);">
            @{
                if (videos?.Count > 0)
                {
                    for (int j = 99999; j < videos.Count + 99999; j += 1)
                    {
                        int videoPosicion = j - 99999;
                        string capturaVideo = videos[videoPosicion].CapturaPequeña;

                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, videoPosicion + 99999))" style="position: relative;">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaVideo, 232, 130)" style="width: 100%;" alt="@videos[videoPosicion].Nombre">

                            <div style="max-width: 42px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <svg class="svg-boton" style="cursor: pointer;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                    <path d="M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9l0 176c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z" />
                                </svg>
                            </div>
                        </div>
                    }
                }

                int i = 0;
                while (i < capturas.Count)
                {
                    int nuevaPosicion = i;
                    string capturaMiniatura = capturas[i].Imagen.Replace(".jpg", ".600x338.jpg");
                    bool difuminarMiniatura = false;

                    if (string.IsNullOrEmpty(usuarioId) == true)
                    {
                        if (string.IsNullOrEmpty(mayorEdad) == false)
                        {
                            if (mayorEdad.ToLower() == "true")
                            {
                                difuminarMiniatura = true;
                            }
                        }

                        if (capturas[i].MayorEdad == true)
                        {
                            difuminarMiniatura = true;
                        }
                    }

                    if (difuminarMiniatura == false)
                    {
                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, nuevaPosicion))">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaMiniatura, 220, 124)" style="width: 100%;" alt="@nombre">
                        </div>
                    }
                    else
                    {
                        <div class="juego-galeria-columna" @onclick="@(e => CambiarMediaMostrar(e, nuevaPosicion))" style="overflow: hidden;">
                            <img class="juego-galeria-capturas juego-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(capturaMiniatura, 220, 124)" style="width: 100%; filter: blur(10px);" alt="@nombre">
                        </div>
                    }

                    i += 1;
                }
            }
        </div>
    </div>
}

@code {

    #nullable disable

    [Parameter]
    public string usuarioId { get; set; }

    [Parameter]
    public string mayorEdad { get; set; }

    [Parameter]
    public string nombre { get; set; }

    [Parameter]
    public List<JuegoMediaCaptura> capturas { get; set; }

    [Parameter]
    public List<JuegoMediaVideo> videos { get; set; }

    private bool javascriptListo = false;

    protected override async Task OnInitializedAsync()
    {
        if (videos?.Count > 0)
        {
            bool cargar = true;

            if (string.IsNullOrEmpty(usuarioId) == true)
            {
                if (string.IsNullOrEmpty(mayorEdad) == false)
                {
                    if (mayorEdad.ToLower() == "true")
                    {
                        cargar = false;
                    }
                }

                if (videos[0].MayorEdad == true)
                {
                    cargar = false;
                }
            }

            if (cargar == true)
            {
                mediaMostrar = videos[0].Enlace;
                mediaMostrarCaptura = videos[0].Captura;
                mediaMostrar = mediaMostrar.Replace("http://", "https://");
                mediaMostrarCaptura = mediaMostrarCaptura.Replace("http://", "https://");
                mediaMostrarPosicion = 99999;

                if (string.IsNullOrEmpty(mediaMostrar) == false)
                {
                    mediaMostrarTipo = null;

                    if (mediaMostrar.EndsWith(".mp4") == true)
                    {
                        mediaMostrarTipo = "video/mp4";
                    }
                    else if (mediaMostrar.EndsWith(".webm") == true)
                    {
                        mediaMostrarTipo = "video/webm";
                    }
                    else if (mediaMostrar.EndsWith(".m3u8") == true)
                    {
                        mediaMostrarTipo = "application/x-mpegURL";
                    }

                    if (string.IsNullOrEmpty(mediaMostrarTipo) == false && javascriptListo == true)
                    {
                        await JavaScript.InvokeVoidAsync("hlsPlayer.loadStream", mediaMostrar);
                    }
                }
            }
        }

        if (mediaMostrarPosicion == 0)
        {
            if (capturas?.Count > 0)
            {
                mediaMostrar = capturas[0].Imagen;
                mediaMostrarPosicion = 1;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool primerRender)
    {
        if (primerRender == true)
        {
            javascriptListo = true;

            await JavaScript.InvokeVoidAsync("hlsPlayer.loadStream", mediaMostrar);
            await JavaScript.InvokeVoidAsync("hlsPlayer.registerTimeUpdate", DotNetObjectReference.Create(this));
        }
    }

    private int mediaMostrarPosicion = 0;
    private string mediaMostrar = string.Empty;
    private string mediaMostrarTipo = string.Empty;
    private string mediaMostrarCaptura = string.Empty;

    private async void CambiarMediaMostrar(MouseEventArgs e, int nuevaCaptura)
    {
        if (nuevaCaptura == 99999)
        {
            mediaMostrar = videos[0].Enlace;
            mediaMostrarCaptura = videos[0].Captura;
        }
        else if (nuevaCaptura == 100000)
        {
            mediaMostrar = videos[1].Enlace;
            mediaMostrarCaptura = videos[1].Captura;
        }
        else if (nuevaCaptura == 100001)
        {
            mediaMostrar = videos[2].Enlace;
            mediaMostrarCaptura = videos[2].Captura;
        }
        else if (nuevaCaptura == 100002)
        {
            mediaMostrar = videos[3].Enlace;
            mediaMostrarCaptura = videos[3].Captura;
        }
        else if (nuevaCaptura == 100003)
        {
            mediaMostrar = videos[4].Enlace;
            mediaMostrarCaptura = videos[4].Captura;
        }
        else if (nuevaCaptura < 99999)
        {
            if (nuevaCaptura < 0)
            {
                nuevaCaptura = capturas.Count - 1;
            }
            else if (nuevaCaptura >= capturas.Count && nuevaCaptura < 99999)
            {
                nuevaCaptura = 0;
            }

            if (nuevaCaptura >= 0 && nuevaCaptura < capturas.Count)
            {
                mediaMostrar = capturas[nuevaCaptura].Imagen;
            }
        }

        mediaMostrar = mediaMostrar?.Replace("http://", "https://");
        mediaMostrarCaptura = mediaMostrarCaptura?.Replace("http://", "https://");
        mediaMostrarPosicion = nuevaCaptura;

        if (string.IsNullOrEmpty(mediaMostrar) == false)
        {
            mediaMostrarTipo = null;

            if (mediaMostrar.EndsWith(".mp4") == true)
            {
                mediaMostrarTipo = "video/mp4";
            }
            else if (mediaMostrar.EndsWith(".webm") == true)
            {
                mediaMostrarTipo = "video/webm";
            }
            else if (mediaMostrar.EndsWith(".m3u8") == true)
            {
                mediaMostrarTipo = "application/x-mpegURL";
            }

            if (string.IsNullOrEmpty(mediaMostrarTipo) == false && javascriptListo == true)
            {
                await JavaScript.InvokeVoidAsync("hlsPlayer.loadStream", mediaMostrar);
            }
        }
    }

    private void EjecutarVideo()
    {
        mediaMostrarCaptura = null;
    }

    private ElementReference videoRef;

    private bool isPlaying = false;
    private bool isMuted = false;
    private double volume = 0.7;

    private double ProgressPercent => duration > 0 ? (currentTime / duration) * 100 : 0;
    private double currentTime = 0;
    private double duration = 0;
    private string TimeDisplay => $"{FormatTime(currentTime)} / {FormatTime(duration)}";

    [JSInvokable]
    public Task UpdateTime(double current, double total)
    {
        currentTime = current;
        duration = total;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task TogglePlay()
    {
        isPlaying = await JavaScript.InvokeAsync<bool>("hlsPlayer.togglePlay", videoRef);
    }

    private async Task ToggleMute()
    {
        isMuted = await JavaScript.InvokeAsync<bool>("hlsPlayer.toggleMute", videoRef);
    }

    private async Task ChangeVolume(ChangeEventArgs e)
    {
        volume = Convert.ToDouble(e.Value);
        await JavaScript.InvokeVoidAsync("hlsPlayer.setVolume", videoRef, volume);
    }

    private async Task ToggleFullScreen()
    {
        await JavaScript.InvokeVoidAsync("hlsPlayer.toggleFullScreen");
    }

    private async Task Seek(MouseEventArgs e)
    {
        await JavaScript.InvokeVoidAsync("hlsPlayer.seek", e.ClientX);
    }

    private string FormatTime(double t)
    {
        int minutes = (int)(t / 60);
        int seconds = (int)(t % 60);
        return $"{minutes:D2}:{seconds:D2}";
    }
}