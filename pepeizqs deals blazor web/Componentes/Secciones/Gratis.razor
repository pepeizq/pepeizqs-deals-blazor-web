@page "/free/"

@using APIs.Steam
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.VisualBasic
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data

@inject IHttpContextAccessor Contexto

@{
    string titulo = Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Free");

    string keywords = "free";

    if (juegosActuales.Count > 0)
    {
        int juegos = 0;
        int dlcs = 0;

        foreach (var juego in juegosActuales)
        {
            if (juego != null)
            {
                if (juego.Juego != null)
                {
                    if (juego.Juego.Tipo == Juegos.JuegoTipo.Game)
                    {
                        juegos += 1;
                    }
                    else if (juego.Juego.Tipo == Juegos.JuegoTipo.DLC)
                    {
                        dlcs += 1;
                    }
                }

                string[] keywordsEnBruto = Herramientas.Buscador.LimpiarNombre(juego.Nombre + " " + Gratis2.GratisCargar.DevolverGratis(juego.Tipo).Nombre, false).Split(' ');
                List<string> keywordsLista = new List<string>();
                keywordsLista.AddRange(keywordsEnBruto);

                foreach (var keyword in keywordsLista)
                {
                    if (keywords.Contains(keyword) == false && keyword.Length > 3)
                    {
                        keywords = keywords + ", " + keyword;
                    }
                }
            }
        }

        if (juegos == 0)
        {
            if (dlcs == 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Free"), dlcs.ToString()) + " " + Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Free");
            }
            else if (dlcs > 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Free"), dlcs.ToString()) + " " + Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
        }
        else if (juegos > 0)
        {
            if (juegos == 1 && dlcs == 0)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Free"), juegos.ToString()) + " " + Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Free");
            }
            else if (juegos > 1 && dlcs == 0)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Free"), juegos.ToString()) + " " + Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
            else if (juegos == 1 && dlcs == 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Free"), juegos.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Free") + " " +
                    string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Free"), dlcs.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
            else if (juegos > 1 && dlcs == 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Free"), juegos.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Free") + " " +
                    string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Free"), dlcs.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
            else if (juegos == 1 && dlcs > 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Free"), juegos.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Free") + " " +
                    string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Free"), dlcs.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
            else if (juegos > 1 && dlcs > 1)
            {
                titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Free"), juegos.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Free") + " " +
                    string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Free"), dlcs.ToString()) + " " +
                    Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Free");
            }
        }

        if (string.IsNullOrEmpty(titulo) == true)
        {
            titulo = Herramientas.Idiomas.BuscarTexto(idioma, "String10", "Free");
        }
    }

    string contenidoJson = @"{
        ""@context"": ""https://schema.org"",
		""@type"": ""ItemList"",
		""name"": ""Free PC Games and DLCs to claim"",
		""numberOfItems"": ""@cantidad"",
        ""itemListOrder"": ""Descending"",
		""itemListElement"": [";

    contenidoJson = contenidoJson.Replace("@cantidad", juegosActuales.Count.ToString());

    int j = 0;
    while (j < juegosActuales.Count)
    {
        if (j != 0)
        {
            contenidoJson = contenidoJson + ",";
        }

        contenidoJson = contenidoJson + @"{
            ""@type"": ""ListItem"",
            ""position"": ""@posicion"",
            ""name"": ""@nombre"",
            ""url"": ""@enlace"",
            ""image"": ""@imagen""
        }";

        contenidoJson = contenidoJson.Replace("@posicion", (j + 1).ToString());
        contenidoJson = contenidoJson.Replace("@nombre", juegosActuales[j].Nombre);
        contenidoJson = contenidoJson.Replace("@enlace", "https://" + dominio + "/game/" + juegosActuales[j].JuegoId.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(juegosActuales[j].Nombre) + "/");
        contenidoJson = contenidoJson.Replace("@imagen", juegosActuales[j].Imagen);

        j += 1;
    }

    contenidoJson = contenidoJson + "] }";

    <Titulo tipo="@Titulo.Tipo.Gratis" idioma="@idioma" dominio="@dominio" keywords="@keywords" tituloGratis="@titulo" contenidoJsonGratis="@contenidoJson"/>
}

<script>
    function moverScroll(id) {
        const yOffset = -90;
        const element = document.getElementById(id);
        const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;

        window.scrollTo({ top: y, behavior: 'smooth' });
    }
</script>

<style>
    .caja-archivo-contenido {
        background-color: var(--fondoSubsubcabecera);
        box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
    }

    .caja-archivo-titulo {
        background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
        padding: 20px 30px;
        border: 1px solid var(--fondoSubsubcabecera);
    }
</style>

<div class="subcabecera">
    <div class="cuerpo-ancho sub-subcabecera">
        @if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
        {
            <button class="boton-pequeño" style="@CambiarEstilo(Gratis2.GratisTipo.Desconocido, false) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, Gratis2.GratisTipo.Desconocido, false))">
                <h1 style="font-size: 18px; margin: 0px;">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Free")
                </h1>
            </button>

            @if (tiposActuales.Count > 0 && mostrarArchivo == false)
            {
                foreach (var tipo in tiposActuales)
                {
                    if (tipo != Gratis2.GratisTipo.Desconocido)
                    {
                        <button class="boton-pequeño" style="@CambiarEstilo(tipo, false) width: fit-content; padding: 8px 16px; border-radius: 5px; display: flex; align-items: center; box-shadow: none;" @onclick="@(e => CambiarTipo(e, tipo, false))" title="@Gratis2.GratisCargar.DevolverGratis(tipo).Nombre">
                            <img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(Gratis2.GratisCargar.DevolverGratis(tipo).ImagenIcono)" style="width: 20px; height: 20px;" alt="Store" />
                        </button>
                    }
                }
            }

            <div style="margin-left: auto; display: flex; justify-content: right;">
                <button class="boton-pequeño" style="@CambiarEstilo(Gratis2.GratisTipo.Desconocido, true) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, Gratis2.GratisTipo.Desconocido, true))">
                    <div style="font-size: 16px;">
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Free")
                    </div>
                </button>
            </div>
        }
        else
        {
            <h1 style="font-size: 18px; margin: 0px;">
                @Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Free")
            </h1>
        }
    </div>
</div>

@if (mostrarArchivo == false)
{
    <div class="caja-archivo-contenido cuerpo-ancho" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); justify-items: center; gap: 30px; padding: 30px; margin-top: 40px; margin-bottom: 40px;">
        @foreach (var juego in juegosActuales)
        {
            string enlaceGratis = juego.Enlace;

            if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
            {
                enlaceGratis = Herramientas.EnlaceAcortador.Generar(juego.Enlace, juego.Tipo, usuarioPatreon, false);
            }

            <CajaJuego idGratis="@juego.Id" enlaceGratis="@enlaceGratis" drmGratis="@juego.DRM" tipoGratis="@juego.Tipo" idioma="@idioma" juego="@juego.Juego" juegosUsuario="@juegosUsuario" usuarioDeseadosSteam="@deseadosUsuario?.SteamWishlist" usuarioDeseadosWeb="@deseadosUsuario?.Wishlist" usuarioDeseadosGog="@deseadosUsuario?.GogWishlist" tipo="CajaJuego.Tipo.Gratis" userAgent="@userAgent" />
        }
    </div>
}
else
{
    <div class="caja-archivo-contenido cuerpo-ancho" style="margin-top: 40px; margin-bottom: 40px; padding: 20px;">
        <div style="display: flex; align-items: start; gap: 15px; flex-wrap: wrap;">
            @foreach (var año in años)
            {
                <div>
                    <button @onclick="@(e => CambiarAño(e, año))" class="boton-pequeño" style="padding: 6px 10px; width: fit-content;">
                        @año
                    </button>

                    @if (añoSeleccionado == año)
                    {
                        <div style="background: var(--colorTexto); padding: 2px;" />
                    }
                </div>
            }
        </div>
        
        @if (string.IsNullOrEmpty(añoSeleccionado) == false)
        {
            <hr/>

            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="padding: 6px 10px;">
                    @añoSeleccionado:
                </div>

                @foreach (var gratisPasado in gratisPasados)
                {
                    List<Juegos.JuegoGratis> gratisAño = new List<Juegos.JuegoGratis>();

                    foreach (var juego in gratisPasado.Juegos)
                    {
                        if (juego.FechaEmpieza.Year.ToString() == añoSeleccionado)
                        {
                            gratisAño.Add(juego);
                        }
                    }

                    if (gratisAño.Count > 0)
                    {
                        <div>
                            <a onclick="moverScroll('pasado-@gratisPasado.Tipo.Nombre')" class="boton-pequeño" style="color: var(--colorTexto); text-decoration: none; cursor: pointer; padding: 6px 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <img src="@gratisPasado.Tipo.ImagenIcono" style="width: 22px; height: 22px;" alt="@gratisPasado.Tipo.Nombre" />

                                    <div style="font-size: 14px;">
                                        @gratisAño.Count.ToString()
                                    </div>
                                </div>      
                            </a>
                        </div>
                    }
                }
            </div>
        }
    </div>

    @if (string.IsNullOrEmpty(añoSeleccionado) == false)
    {
        <div class="cuerpo-ancho" style="display: flex; flex-direction: column; gap: 40px; margin-top: 40px; margin-bottom: 40px;">
            @foreach (var gratisPasado in gratisPasados)
            {
                List<Juegos.JuegoGratis> gratisAño = new List<Juegos.JuegoGratis>();

                foreach (var juego in gratisPasado.Juegos)
                {
                    if (juego.FechaEmpieza.Year.ToString() == añoSeleccionado)
                    {
                        gratisAño.Add(juego);
                    }
                }

                if (gratisAño.Count > 0)
                {
                    <div class="caja-archivo-contenido">
                        <div id="pasado-@gratisPasado.Tipo.Nombre" class="caja-archivo-titulo">
                            <img src="@gratisPasado.Tipo.ImagenLogo" alt="@gratisPasado.Tipo.Nombre" style="max-width: 150px; max-height: 70px; object-fit: contain;" />
                        </div>

                        <div style="padding: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; justify-content: flex-start;">
                            @{
                                int i = 1;
                                while (i < 13)
                                {
                                    List<Juegos.JuegoGratis> gratisMensual = new List<Juegos.JuegoGratis>();

                                    foreach (var juego in gratisAño)
                                    {
                                        if (juego.FechaEmpieza.Month == i)
                                        {
                                            gratisMensual.Add(juego);
                                        }
                                    }

                                    if (gratisMensual.Count > 0)
                                    {
                                        gratisMensual = gratisMensual.OrderBy(g => g.Nombre).ToList();

                                        <div>
                                            <label>@Herramientas.Idiomas.BuscarTexto(idioma, "Month." + i.ToString(), "Months") (@gratisMensual.Count.ToString())</label>

                                            <ul>
                                                @foreach (var juegoMensual in gratisMensual)
                                                {
                                                    <li style="margin-bottom: 5px;">
                                                        <a href="/game/@juegoMensual.JuegoId/@Herramientas.EnlaceAdaptador.Nombre(juegoMensual.Nombre)/">
                                                            <label style="cursor: pointer;">@juegoMensual.Nombre</label>

                                                            @if (gratisPasado.Tipo.DRMEnseñar == true)
                                                            {
                                                                <label style="cursor: pointer; margin-left: 5px;">(@Juegos.JuegoDRM2.DevolverDRM(juegoMensual.DRM))</label>
                                                            }
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }

                                    i += 1;
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
}

@code {

    #nullable disable

    private string idioma = "en";
    private string usuarioId = null;
    private string userAgent = null;
    private string dominio = null;

    [PersistentState] public Herramientas.UsuarioListadosJuegos juegosUsuario { get; set; }
    [PersistentState] public Usuario deseadosUsuario { get; set; }
    private bool usuarioPatreon = false;

    [PersistentState] public List<Juegos.JuegoGratis> juegosActuales { get; set; }
    private List<Gratis2.GratisComponente> gratisPasados = new List<Gratis2.GratisComponente>();

    private List<string> años = new List<string>();
    private string añoSeleccionado = string.Empty;

    protected override void OnInitialized()
    {
        Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
        idioma = datos.Idioma;
        usuarioId = datos.UsuarioId;
        userAgent = datos.UserAgent;
        dominio = datos.Dominio;

        if (string.IsNullOrEmpty(usuarioId) == false)
        {
            idioma = BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
            juegosUsuario ??= Herramientas.UsuarioJuegos.Cargar(usuarioId);
            deseadosUsuario ??= BaseDatos.Usuarios.Buscar.DeseadosTiene(usuarioId);
            usuarioPatreon = Herramientas.Patreon.VerificarActivo(BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
        }

        //--------------------------------------------------------------------

        DateTime arranque = new DateTime(2011, 1, 1);

        int i = 0;
        while (i < 100)
        {
            if (arranque.Year != DateTime.Now.Year)
            {
                años.Add(arranque.Year.ToString());
                arranque = arranque.AddYears(1);
            }
            i += 1;
        }

        años.Add(DateTime.Now.Year.ToString());
        años.Reverse();

        //--------------------------------------------------------------------

        juegosActuales ??= BaseDatos.Gratis.Buscar.Actuales();

        if (juegosActuales?.Count > 0)
        {
            foreach (var juegoActual in juegosActuales)
            {
                Juegos.Juego juego2 = BaseDatos.Juegos.Buscar.UnJuego(juegoActual.JuegoId.ToString());
                juegoActual.Imagen = juego2.Imagenes.Header_460x215;
                juegoActual.Juego = juego2;

                bool añadirTipo = true;

                if (tiposActuales.Count > 0)
                {
                    foreach (var tipoActual in tiposActuales)
                    {
                        if (tipoActual == juegoActual.Tipo)
                        {
                            añadirTipo = false;
                        }
                    }
                }

                if (añadirTipo == true)
                {
                    tiposActuales.Add(juegoActual.Tipo);
                }
            }
        }

        if (tiposActuales.Count > 0)
        {
            tiposActuales = tiposActuales.OrderBy(x => (int)x).ToList();
        }
    }

    private Gratis2.GratisTipo tipoSeleccionado = Gratis2.GratisTipo.Desconocido;
    private List<Gratis2.GratisTipo> tiposActuales = new List<Gratis2.GratisTipo>();
    private bool mostrarArchivo = false;

    private void CambiarTipo(MouseEventArgs e, Gratis2.GratisTipo nuevoTipo, bool esArchivo)
    {
        mostrarArchivo = esArchivo;

        if (esArchivo == false)
        {
            tipoSeleccionado = nuevoTipo;
            juegosActuales = BaseDatos.Gratis.Buscar.Actuales(nuevoTipo);

            if (juegosActuales.Count > 0)
            {
                foreach (var juegoActual in juegosActuales)
                {
                    Juegos.Juego juego2 = BaseDatos.Juegos.Buscar.UnJuego(juegoActual.JuegoId.ToString());
                    juegoActual.Imagen = juego2.Imagenes.Header_460x215;
                    juegoActual.Juego = juego2;
                }
            }
        }
        else
        {
            añoSeleccionado = DateTime.Now.Year.ToString();
            GenerarArchivo();
        }
    }

    private string CambiarEstilo(Gratis2.GratisTipo nuevoTipo, bool esArchivo)
    {
        if (mostrarArchivo == true && esArchivo == true)
        {
            if (nuevoTipo != Gratis2.GratisTipo.Desconocido)
            {
                return "background-color: transparent;";
            }
            else
            {
                return "background-color: var(--botonSubcabecera); box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.25),0px 0px 1px 0px rgba(0, 0, 0, 0.25);";
            }
        }
        else
        {
            if (tipoSeleccionado == nuevoTipo && mostrarArchivo == false && esArchivo == false)
            {
                return "background-color: var(--botonSubcabecera); box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.25),0px 0px 1px 0px rgba(0, 0, 0, 0.25);";
            }
            else
            {
                return "background-color: transparent;";
            }
        }
    }

    #region Archivo

    private void CambiarAño(MouseEventArgs e, string nuevoAño)
    {
        añoSeleccionado = nuevoAño;
        GenerarArchivo();
    }

    private void GenerarArchivo()
    {
        List<Juegos.JuegoGratis> juegosPasados = BaseDatos.Gratis.Buscar.Año(añoSeleccionado);

        if (juegosPasados.Count > 0)
        {
            gratisPasados.Clear();

            foreach (var gratis in Gratis2.GratisCargar.GenerarListado())
            {
                List<Juegos.JuegoGratis> juegos2 = new List<Juegos.JuegoGratis>();

                foreach (var juego in juegosPasados)
                {
                    if (juego.Tipo == gratis.Tipo)
                    {
                        juegos2.Add(juego);
                    }
                }

                if (juegos2.Count > 0)
                {
                    Gratis2.GratisComponente componente = new Gratis2.GratisComponente();
                    componente.Juegos = juegos2;
                    componente.Tipo = gratis;

                    gratisPasados.Add(componente);
                }
            }
        }
    }

    #endregion
}
