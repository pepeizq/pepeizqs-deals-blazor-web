@page "/"

@using BlazorNotification
@using Juegos
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Identity
@using Microsoft.Data.SqlClient
@using Microsoft.JSInterop
@using Microsoft.VisualBasic
@using Noticias
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data
@using System.Text.Json

@inject IHttpContextAccessor Contexto
@inject IBlazorNotificationService ServicioNotificaciones

@{
	#nullable disable

	WebApplicationBuilder builder = WebApplication.CreateBuilder();
	string patreon = builder.Configuration.GetValue<string>("RedesSociales:Patreon");
	string discord = builder.Configuration.GetValue<string>("RedesSociales:Discord");
	string telegram = builder.Configuration.GetValue<string>("RedesSociales:Telegram");
	string twitter = builder.Configuration.GetValue<string>("RedesSociales:Twitter");
	string steam = builder.Configuration.GetValue<string>("RedesSociales:Steam");
	string bluesky = builder.Configuration.GetValue<string>("RedesSociales:Bluesky");

	string contenidoJson = @"{
        ""@context"": ""https://schema.org"",
		""@type"": ""Organization"",
		""name"": ""pepeizq's deals"",
		""description"": ""@descripcion"",
        ""url"": ""https://@dominio/"",
        ""brand"": ""pepeizq's apps"",
		""logo"": {
			""@type"": ""ImageObject"",
			""logo"": ""https://@dominio/logo/logo6.png"",
			""caption"": ""pepeizq's deals logo"" },
		""contactPoint"": {
			""@type"": ""ContactPoint"",
			""contactType"": ""customer service"",
			""url"": ""https://@dominio/contact/"",
			""availableLanguage"": [ ""English"", ""Spanish"" ] },
		""sameAs"": [ ""@patreon"", ""@discord"", ""@telegram"", ""@twitter"", ""@steam"", ""@bluesky""]
	}";

	contenidoJson = contenidoJson.Replace("@dominio", dominio);
	contenidoJson = contenidoJson.Replace("@descripcion", Herramientas.Idiomas.BuscarTexto(idioma, "Subtitle", "Index"));
	contenidoJson = contenidoJson.Replace("@patreon", patreon);
	contenidoJson = contenidoJson.Replace("@discord", discord);
	contenidoJson = contenidoJson.Replace("@telegram", telegram);
	contenidoJson = contenidoJson.Replace("@twitter", twitter);
	contenidoJson = contenidoJson.Replace("@steam", steam);
	contenidoJson = contenidoJson.Replace("@bluesky", bluesky);

	<Titulo tipo="@Titulo.Tipo.Portada" idioma="@idioma" dominio="@dominio" contenidoJsonPortada="@contenidoJson"/>
}

<style>
	.portada-espacio {
		margin: 40px auto;
	}

	.portada-sub-subcabecera {
		padding: 20px 0px;
	}

	.destacado-fondo {
		display: block;
	}

	.destacado-video {
		display: none;
	}

	.destacado-mostrar:hover .destacado-fondo {
		display: none;
	}

	.destacado-mostrar:hover .destacado-video {
		display: block;
	}

	.destacados-galeria-cursor {
		cursor: pointer;
	}

	.destacados-galeria-fila {
		display: flex;
		overflow: auto;
		padding: 5px 0px;
		gap: 10px;
		flex-wrap: wrap;
		justify-content: center;
		margin-top: 5px;
	}

	.destacados-galeria-fila:after {
		content: "";
		display: table;
		clear: both;
	}

	.destacados-galeria-columna {
		float: left;
		width: 16%;
		flex: 0 0 auto;
		aspect-ratio: 92/43;
		box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.28),0px 0px 1px 0px rgba(0, 0, 0, 0.24);
	}

	.destacados-galeria-captura {
		opacity: 0.3;
		object-fit: cover;
		overflow: hidden;
		transition: transform .2s;
		min-width: 100px;
		min-height: 50px;
		max-width: 100%;
	}

	.destacados-galeria-captura:hover {
		opacity: 1;
		transform: scale(1.01);
	}

	.destacado-hueco {
		padding: 80px 60px 30px 60px;
	}

	.destacado-logo-medidas {
		width: 16vw;
		height: 8vw;
		object-fit: contain;
	}

	.destacado-logo-alto {
		height: 150px;
	}

	.destacado-precio-descuento {
		padding: 12px 15px;
		font-size: 22px;
	}

	.destacado-icono {
		width: 40px;
		height: 40px;
		filter: drop-shadow(0 0 8px rgba(0,0,0,.5));
	}

	.destacado-sombra {
		filter: drop-shadow(0 0 8px rgba(0,0,0,.5));
	}

	@@media (max-width: 1000px) {
		.portada-espacio {
			margin: 0px auto;
		}

		.portada-sub-subcabecera {
			padding: 20px 5px;
		}

		.destacado-hueco {
			padding: 40px 30px 15px 30px;
		}

		.destacado-logo-medidas {
			width: 16vw;
			height: 8vw;
		}

		.destacado-logo-alto {
			height: 100px;
		}

		.destacado-precio-descuento {
			padding: 6px 8px;
			font-size: 15px;
		}

		.destacado-icono {
			width: 24px;
			height: 24px;
		}
	}

	.destacado-progreso {
		animation: barraProgreso 30s ease-in-out;
	}

	@@keyframes barraProgreso {
	0% { width: 0; }
	100% { width: 100%; }
	}
</style>

<script>
	function anularEnlace(event) {
	  event.preventDefault() 
	}
</script>

<script>
	function enseñarTooltip(e, id) {
		var x = e.clientX,
			y = e.clientY;

		var tooltip = document.getElementById(id);

		if (screen.width / 2 > x) {
			tooltip.style.top = (y + 10) + 'px';
			tooltip.style.left = (x + 20) + 'px';
		}
		else {
			tooltip.style.top = (y - 10) + 'px';
			tooltip.style.left = (x - 20 - tooltip.getBoundingClientRect().width) + 'px';
		};
	}
</script>
	
@if (juegosDestacadosMostrar?.Count > 0)
{
	<div class="portada-espacio cuerpo-ancho">
		@if (juegosDestacadosMostrar[posicionMostrarDestacados].Juego != null)
		{
			<a href="/game/@juegosDestacadosMostrar[posicionMostrarDestacados].Juego.IdMaestra.ToString()/@Herramientas.EnlaceAdaptador.Nombre(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Nombre)/" style="cursor: pointer; border: 0px; padding: 0px; display: block; width: 100%;">
				<div style="position: relative; box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.28),0px 0px 1px 0px rgba(0, 0, 0, 0.24); background-color: @juegosDestacadosMostrar[posicionMostrarDestacados].Color;">
					<div class="destacado-mostrar" @onmouseover="@(e => EnseñarDestacadoVideo(e, juegosDestacadosMostrar[posicionMostrarDestacados].Juego))">
						@if (string.IsNullOrEmpty(videoDestacado) == false)
						{
							<div class="destacado-fondo">
								<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Imagenes.Library_1920x620, 1314, 424)" style="width: 100%;" alt="@juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Nombre">
							</div>

							<div class="destacado-video">
								<video onloadedmetadata="this.muted=true" playsinline autoplay loop muted style="height: 100%; width: 100%; overflow: hidden; aspect-ratio: 3.145/1; object-fit: cover;">
									<source src="@videoDestacado" type="video/mp4" />
									<source src="@videoDestacado.Replace(".mp4", ".webm")" type="video/webm" />
								</video>
							</div>
						}
						else
						{
							<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Imagenes.Library_1920x620, 1314, 424)" style="width: 100%; aspect-ratio: 96/31;" alt="@juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Nombre">
						}

						<div style="position: absolute; left: 0; bottom: 0; background-image: linear-gradient(to bottom, rgba(255,0,0,0), @juegosDestacadosMostrar[posicionMostrarDestacados].Color);
									display: flex; align-items: end; justify-content: space-between; width: 100%;" class="destacado-hueco">

							<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Imagenes.Logo)" class="destacado-logo-medidas" alt="@juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Nombre">

							<div style="display: flex; align-items: center; margin-bottom: 30px; color: var(--colorTexto);">
								<img class="destacado-icono" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(JuegoDRM2.SacarImagen(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos[0].DRM), 40, 40)" style="margin-right: 20px;" alt="DRM" />

								@{
									string iconoTienda = string.Empty;
									List<Tiendas2.Tienda> tiendas = Tiendas2.TiendasCargar.GenerarListado();

									foreach (var tienda in tiendas)
									{
										if (tienda.Id == juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos[0].Tienda)
										{
											iconoTienda = tienda.ImagenIcono;
											break;
										}
									}
								}

								<img class="destacado-icono" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(iconoTienda, 40, 40)" style="margin-right: 40px;" alt="Store" />

								<div class="destacado-sombra" style="display: flex; align-items: center;">
									<div class="destacado-precio-descuento" style="background-color: darkgreen;">
										@juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos[0].Descuento.ToString()%
									</div>
									<div class="destacado-precio-descuento" style="background-color: var(--fondoOscuro);">
										@{
											string precioMostrar = string.Empty;

											if (juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos?[0].PrecioCambiado > 0)
											{
												precioMostrar = Herramientas.Precios.Euro(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos?[0].PrecioCambiado);
											}
											else
											{
												precioMostrar = Herramientas.Precios.Euro(juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos?[0].Precio);
											}
										}

										@precioMostrar
									</div>
								</div>

								@if (string.IsNullOrEmpty(usuarioId) == false && juegosDestacadosMostrar[posicionMostrarDestacados].Color != "var(--fondoBien)" && @juegosDestacadosMostrar[posicionMostrarDestacados].DeseadoImportado == false)
								{
									<div onclick="anularEnlace(event)" class="tooltip-juego" style="margin-left: 20px;" onmousemove="enseñarTooltip(event, 'tooltip-destacados-deseados')">
										<button @onclick="@(e => CambiarEstadoDeseado(e, usuarioId, juegosDestacadosMostrar[posicionMostrarDestacados], juegosDestacadosMostrar[posicionMostrarDestacados].Juego.PrecioMinimosHistoricos[0].DRM))" class="boton-pequeño" style="width: fit-content; padding: 10px; background-color: @juegosDestacadosMostrar[posicionMostrarDestacados].Color;">
											<div class="svg-boton" style="width: 35px; height: 35px;">
												@if (juegosDestacadosMostrar[posicionMostrarDestacados].Color == "var(--fondoAlerta)")
												{
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
														<path d="M183.1 137.4C170.6 124.9 150.3 124.9 137.8 137.4C125.3 149.9 125.3 170.2 137.8 182.7L275.2 320L137.9 457.4C125.4 469.9 125.4 490.2 137.9 502.7C150.4 515.2 170.7 515.2 183.2 502.7L320.5 365.3L457.9 502.6C470.4 515.1 490.7 515.1 503.2 502.6C515.7 490.1 515.7 469.8 503.2 457.3L365.8 320L503.1 182.6C515.6 170.1 515.6 149.8 503.1 137.3C490.6 124.8 470.3 124.8 457.8 137.3L320.5 274.7L183.1 137.4z" />
													</svg>
												}
												else
												{
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
														<path d="M341.5 45.1C337.4 37.1 329.1 32 320.1 32C311.1 32 302.8 37.1 298.7 45.1L225.1 189.3L65.2 214.7C56.3 216.1 48.9 222.4 46.1 231C43.3 239.6 45.6 249 51.9 255.4L166.3 369.9L141.1 529.8C139.7 538.7 143.4 547.7 150.7 553C158 558.3 167.6 559.1 175.7 555L320.1 481.6L464.4 555C472.4 559.1 482.1 558.3 489.4 553C496.7 547.7 500.4 538.8 499 529.8L473.7 369.9L588.1 255.4C594.5 249 596.7 239.6 593.9 231C591.1 222.4 583.8 216.1 574.8 214.7L415 189.3L341.5 45.1z" />
													</svg>
												}
											</div>
										</button>

										<div id="tooltip-destacados-deseados" class="tooltip-relleno">
											<div style="margin: 4px; font-size: 14px;">
												@if (juegosDestacadosMostrar[posicionMostrarDestacados].Color == "var(--fondoAlerta)")
												{
													@Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Index")
												}
												else
												{
													@Herramientas.Idiomas.BuscarTexto(idioma, "String12", "Index")
												}
											</div>
										</div>
									</div>
								}
							</div>
						</div>
					</div>
				</div>
			</a>
		}

		<div class="destacados-galeria-fila">
			@foreach (var destacado in juegosDestacadosMostrar)
			{
				bool mostrarBarra = false;
				string opacidad = string.Empty;

				if (juegosDestacadosMostrar[posicionMostrarDestacados] != null)
				{
					if (destacado.Juego.IdMaestra == juegosDestacadosMostrar[posicionMostrarDestacados].Juego.IdMaestra)
					{
						opacidad = "opacity: 1;";
						mostrarBarra = true;
					}
				}

				<div class="destacados-galeria-columna" @onclick="@(e => CambiarJuegoDestacado(e, destacado))" style="background-color: @destacado.Color;">
					<img @key="destacado.Juego.Id.ToString()" class="destacados-galeria-captura destacados-galeria-cursor" src="@Herramientas.Ficheros.Imagenes.ServidorExterno(destacado.Juego.Imagenes.Header_460x215, 214, 100)" style="@opacidad" alt="@destacado.Juego.Nombre">

					@if (mostrarBarra == true)
					{
						<div style="height: 3px; width: 100%;">
							<div class="destacado-progreso" style="height: 3px; filter: brightness(150%); background: color-mix(in srgb, var(--fondoCodigo), @destacado.Color 50%);" />
						</div>
					}
				</div>
			}
		</div>
	</div>
}

<div style="background-color: var(--fondoSubcabecera);">
	<div class="cuerpo-ancho portada-sub-subcabecera" style="font-size: 18px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
		@if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
		{
			<button class="boton-pequeño" style="@CambiarEstilo(Noticias.NoticiaTipo.Desconocido) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, Noticias.NoticiaTipo.Desconocido))">
				<h1 style="font-size: 18px; margin: 0px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Index")
				</h1>
			</button>

			@if (tiposActualesNoticias?.Count > 1)
			{
				tiposActualesNoticias = tiposActualesNoticias.OrderBy(x => Noticias.NoticiasCargar.Traduccion(x, idioma)).ToList();

				foreach (var tipo in tiposActualesNoticias)
				{
					if (tipo != NoticiaTipo.Desconocido)
					{
						<button class="boton-pequeño" style="@CambiarEstilo(tipo) width: fit-content; font-size: 18px; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, tipo))" title="@Noticias.NoticiasCargar.Traduccion(tipo, idioma)">
							@Noticias.NoticiasCargar.Traduccion(tipo, idioma)
						</button>
					}
				}
			}
		}
		else
		{
			<h1 style="font-size: 18px; margin: 0px;">
				@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Index")
			</h1>
		}

		<div style="margin-left: auto; display: flex; justify-content: right; align-items: center; gap: 20px;">
			<RedesSociales idioma="@idioma" />
		</div>
	</div>
</div>

<div style="background-color: var(--fondoPortadaNoticias);">
    <div class="cuerpo-ancho" style="padding: 20px 0px; display: flex; flex-direction: column; gap: 40px;">
		@{
			string marginAbajo = string.Empty;

			if (noticias.Count > 0)
			{
				marginAbajo = "margin-bottom: 20px;";

				<div title="@Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Index")">
					<Virtualize Context="noticia" Items="noticias">
						<ItemContent>
							<CajaNoticia idioma="@idioma" noticia="@noticia" tipo="@CajaNoticia.Tipo.Portada" />
						</ItemContent>
					</Virtualize>
				</div>
			}
		}

		<div style="display: flex; align-items: center; gap: 40px; justify-content: center; @marginAbajo">
			<a class="boton-pequeño" style="padding: 15px 30px; width: fit-content;" href="/last-news">
				@Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Index")
			</a>
		</div>
	</div>
</div>

@if (juegosMinimosMostrar?.Count > 0)
{
	<div style="background-color: var(--fondoSubcabecera);">
		<div class="cuerpo-ancho portada-sub-subcabecera" style="font-size: 18px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
			@if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
			{
				<button class="boton-pequeño" style="@CambiarEstilo(MinimosTipo.Nuevos) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, MinimosTipo.Nuevos))">
					<div style="font-size: 18px; margin: 0px;">
						@CambiarTexto(MinimosTipo.Nuevos, Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Index"))
					</div>
				</button>

				<button class="boton-pequeño" style="@CambiarEstilo(MinimosTipo.Populares) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, MinimosTipo.Populares))">
					<div style="font-size: 18px; margin: 0px;">
						@CambiarTexto(MinimosTipo.Populares, Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Index"))
					</div>
				</button>

				<button class="boton-pequeño" style="@CambiarEstilo(MinimosTipo.Lanzamientos) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, MinimosTipo.Lanzamientos))">
					<div style="font-size: 18px; margin: 0px;">
						@CambiarTexto(MinimosTipo.Lanzamientos, Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Index"))
					</div>
				</button>

				<button class="boton-pequeño" style="@CambiarEstilo(MinimosTipo.Proximamente) width: fit-content; padding: 8px 20px; border-radius: 5px; box-shadow: none;" @onclick="@(e => CambiarTipo(e, MinimosTipo.Proximamente))">
					<div style="font-size: 18px; margin: 0px;">
						@CambiarTexto(MinimosTipo.Proximamente, Herramientas.Idiomas.BuscarTexto(idioma, "String11", "Index"))
					</div>
				</button>

				<div style="margin-left: auto; display: flex; justify-content: right; align-items: center; gap: 20px;">
					<button class="boton-pequeño" @onclick="EnseñarFiltrado" style="width: fit-content; padding: 10px 15px; border: 0px; background-color: transparent; box-shadow: none;">
						<div style="width: 22px;">
							<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
								<path d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" />
							</svg>
						</div>
					</button>
				</div>
			}
			else
			{
				<div style="font-size: 18px; margin: 0px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Index")
				</div>
			}
		</div>
	</div>

	<div class="portada-espacio" style="max-width: 1000px; width: 100vw; margin-top: 20px;">
		<div style="display: flex; flex-direction: column; gap: 30px; margin-bottom: 15px;">
			@{
				CajaJuego.Tipo tipoJuego = CajaJuego.Tipo.PortadaNuevos;

				if (tipoSeleccionadoMinimos == MinimosTipo.Populares)
				{
					tipoJuego = CajaJuego.Tipo.PortadaPopulares;
				}
				else if (tipoSeleccionadoMinimos == MinimosTipo.Lanzamientos)
				{
					tipoJuego = CajaJuego.Tipo.PortadaLanzamientos;
				}
				else if (tipoSeleccionadoMinimos == MinimosTipo.Proximamente)
				{
					tipoJuego = CajaJuego.Tipo.PortadaProximamente;
				}
			}

			<Virtualize Context="juego" Items="juegosMinimosMostrar" ItemSize="107" OverscanCount="12">
				<ItemContent>
					<div style="display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden; box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.28),0px 0px 1px 0px rgba(0, 0, 0, 0.24);" @onmouseenter="(e => MostrarBotonDeseados(e, juego))" @onmouseleave="(e => OcultarBotonDeseados(e, juego))">
						<div style="width: 100%;">
							<CajaJuego idioma="@idioma" juego="@juego.Juego" color="@juego.Color" juegosUsuario="@juegosUsuario" usuarioDeseadosSteam="@deseadosUsuario?.SteamWishlist" usuarioDeseadosWeb="@deseadosUsuario?.Wishlist" usuarioDeseadosGog="@deseadosUsuario?.GogWishlist" tipo="@tipoJuego" userAgent="@userAgent" />
						</div>
						
						@if (string.IsNullOrEmpty(usuarioId) == false && juego.Color != "var(--fondoBien)" && juego.DeseadoImportado == false && juego.DeseadoMostrar == true)
						{
							<div style="position: absolute; top: 0; left: 0;" class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-deseados')">
								<button @onclick="@(e => CambiarEstadoDeseado(e, usuarioId, juego, juego.Juego.PrecioMinimosHistoricos[0].DRM))" class="boton-pequeño" style="width: fit-content; padding: 10px; background-color: @juego.Color;">
									<div class="svg-boton" style="width: 24px; height: 24px; display: flex;">
										@if (juego.Color == "var(--fondoAlerta)")
										{
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
												<path d="M183.1 137.4C170.6 124.9 150.3 124.9 137.8 137.4C125.3 149.9 125.3 170.2 137.8 182.7L275.2 320L137.9 457.4C125.4 469.9 125.4 490.2 137.9 502.7C150.4 515.2 170.7 515.2 183.2 502.7L320.5 365.3L457.9 502.6C470.4 515.1 490.7 515.1 503.2 502.6C515.7 490.1 515.7 469.8 503.2 457.3L365.8 320L503.1 182.6C515.6 170.1 515.6 149.8 503.1 137.3C490.6 124.8 470.3 124.8 457.8 137.3L320.5 274.7L183.1 137.4z" />
											</svg>
										}
										else
										{
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
												<path d="M341.5 45.1C337.4 37.1 329.1 32 320.1 32C311.1 32 302.8 37.1 298.7 45.1L225.1 189.3L65.2 214.7C56.3 216.1 48.9 222.4 46.1 231C43.3 239.6 45.6 249 51.9 255.4L166.3 369.9L141.1 529.8C139.7 538.7 143.4 547.7 150.7 553C158 558.3 167.6 559.1 175.7 555L320.1 481.6L464.4 555C472.4 559.1 482.1 558.3 489.4 553C496.7 547.7 500.4 538.8 499 529.8L473.7 369.9L588.1 255.4C594.5 249 596.7 239.6 593.9 231C591.1 222.4 583.8 216.1 574.8 214.7L415 189.3L341.5 45.1z" />
											</svg>
										}
									</div>
								</button>

								<div id="tooltip-deseados" class="tooltip-relleno">
									<div style="margin: 4px; font-size: 14px;">
										@if (juego.Color == "var(--fondoAlerta)")
										{
											@Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Index")
										}
										else
										{
											@Herramientas.Idiomas.BuscarTexto(idioma, "String12", "Index")
										}
									</div>
								</div>
							</div>
						}
					</div>
				</ItemContent>
			</Virtualize>
		</div>

		@{
			bool llegadoLimite = false;

			if (cantidadJuegosMinimos > juegosMinimosMostrar.Count)
			{
				llegadoLimite = true;
			}
			else
			{
				if (string.IsNullOrEmpty(usuarioId) == false)
				{
					if (usuarioPatreon == true || usuarioAdmin == true)
					{
						if (cantidadJuegosMinimos > 950 && cantidadJuegosMinimos <= 1000)
						{
							llegadoLimite = true;
						}
					}
					else
					{
						if (cantidadJuegosMinimos > 450 && cantidadJuegosMinimos <= 500)
						{
							llegadoLimite = true;
						}
					}
				}
				else
				{
					if (cantidadJuegosMinimos > 150 && cantidadJuegosMinimos <= 200)
					{
						llegadoLimite = true;
					}
				}
			}

			<div style="margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 40px;">
				@if (llegadoLimite == false)
				{
					<button class="boton-pequeño" @onclick="CargarMasMinimos" style="width: fit-content; padding: 15px 30px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Index")
					</button>
				}

				<a class="boton-pequeño" href="/historical-lows" style="width: fit-content; padding: 15px 30px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Index")
				</a>
			</div>
		}
	</div>	
}


@if (mostrarFiltrado == true)
{
	<div class="opciones-panel">
		<div style="max-width: 800px; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
			<div style="display: flex; align-items: center; gap: 30px; padding: 20px; background-color: var(--fondoSubsubcabecera);">
				<button class="boton-pequeño" @onclick="OcultarFiltrado" style="width: fit-content; padding: 10px 15px;">
					<div style="max-width: 24px; max-height: 24px;">
						<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
							<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
						</svg>
					</div>
				</button>

				<div style="font-size: 20px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "Filter", "Index")
				</div>
			</div>

			<div style="display: flex; flex-direction: column; gap: 30px; padding: 20px;">
				<AuthorizeView>
					<Authorized>
						<div style="display: flex; flex-direction: column; gap: 30px; background-color: var(--fondoSubsubcabecera); border: 2px solid var(--fondoSubcabecera); box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24); padding: 20px;">
							<div style="display: flex; align-items: center; gap: 20px;">
								<div class="checkbox-caja">
									<input type="checkbox" class="checkbox-interior" checked="@ocultarJuegosUsuarioSteam" @onchange="OcultarJuegosUsuarioSteam">
								</div>

								<div>
									@Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption1", "Index")
								</div>
							</div>

							<div style="display: flex; align-items: center; gap: 20px;">
								<div class="checkbox-caja">
									<input type="checkbox" class="checkbox-interior" checked="@ocultarJuegosUsuarioGog" @onchange="OcultarJuegosUsuarioGog">
								</div>

								<div>
									@Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption4", "Index")
								</div>
							</div>
						</div>
					</Authorized>
				</AuthorizeView>

				<div style="background-color: var(--fondoSubsubcabecera); border: 2px solid var(--fondoSubcabecera); box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24); padding: 20px;">
					<div style="padding-bottom: 15px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption2", "Index")
					</div>

					<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
						@foreach (var drm in drms)
						{
							string iconoDRM = string.Empty;
							string nombreDRM = string.Empty;

							foreach (var drm2 in JuegoDRM2.GenerarListado())
							{
								if (drm2.Id == drm.DRMId)
								{
									iconoDRM = drm2.Imagen;
									nombreDRM = drm2.Nombre;
								}
							}

							<div style="display: flex; align-items: center;" title="@nombreDRM">
								<div class="checkbox-caja">
									<input type="checkbox" class="checkbox-interior" checked="@drm.Checkbox" @onchange="@(e => EnseñarJuegosDRM(e, drm.DRMId))">
								</div>

								@if (drm.DRMId != JuegoDRM.DRMFree)
								{
									<div style="margin-left: 20px;">
										<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(iconoDRM)" style="max-width: 24px; max-height: 24px;" title="@nombreDRM" loading="lazy" />
									</div>
								}
								else
								{
									<div style="margin-left: 20px;">
										<label style="font-size: 10px; max-width: 24px; text-align: center;">@nombreDRM</label>
									</div>
								}
							</div>
						}
					</div>
				</div>

				<div style="background-color: var(--fondoSubsubcabecera); border: 2px solid var(--fondoSubcabecera); box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24); padding: 20px;">
					<div style="padding-bottom: 15px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption3", "Index")
					</div>

					<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
						@foreach (var categoria in categorias)
						{
							string nombreCategoria = string.Empty;

							if (categoria.Categoria == JuegoTipo.Game)
							{
								nombreCategoria = Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption3.1", "Index");
							}
							else if (categoria.Categoria == JuegoTipo.DLC)
							{
								nombreCategoria = Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption3.2", "Index");
							}
							else if (categoria.Categoria == JuegoTipo.Music)
							{
								nombreCategoria = Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption3.3", "Index");
							}
							else if (categoria.Categoria == JuegoTipo.Software)
							{
								nombreCategoria = Herramientas.Idiomas.BuscarTexto(idioma, "FilterOption3.4", "Index");
							}

							<div style="display: flex; align-items: center;" title="@nombreCategoria">
								<div class="checkbox-caja">
									<input type="checkbox" class="checkbox-interior" checked="@categoria.Checkbox" @onchange="@(e => EnseñarJuegosCategoria(e, categoria.Categoria))">
								</div>

								<div style="margin-left: 15px;">
									<label style="font-size: 14px;">@nombreCategoria</label>
								</div>
							</div>
						}
					</div>
				</div>
			</div>
		</div>
	</div>
}

@code {

	#nullable disable

	private string idioma = "en";
	private string usuarioId = null;
	private string userAgent = null;
	private string dominio = null;

	[PersistentState] public Herramientas.UsuarioListadosJuegos juegosUsuario { get; set; }
	[PersistentState] public Usuario deseadosUsuario { get; set; }
	private bool usuarioPatreon = false;
	private bool usuarioAdmin = false;

	private string videoDestacado = string.Empty;

	private SqlConnection conexion = new SqlConnection();

	protected override void OnInitialized()
	{
		Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
		idioma = datos.Idioma;
		usuarioId = datos.UsuarioId;
		userAgent = datos.UserAgent;
		dominio = datos.Dominio;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			idioma = BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
			juegosUsuario ??= Herramientas.UsuarioJuegos.Cargar(usuarioId);
			deseadosUsuario ??= BaseDatos.Usuarios.Buscar.DeseadosTiene(usuarioId);
			usuarioPatreon = Herramientas.Patreon.VerificarActivo(BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
			usuarioAdmin = BaseDatos.Usuarios.Buscar.RolDios(usuarioId);

			Usuario opciones = BaseDatos.Usuarios.Buscar.OpcionesPortada(usuarioId);

			if (opciones != null)
			{
				#region Filtrado

				if (opciones.IndexOption1 == true)
				{
					ocultarJuegosUsuarioSteam = "checked";
				}
				else
				{
					ocultarJuegosUsuarioSteam = null;
				}

				if (opciones.IndexOption2 == true)
				{
					ocultarJuegosUsuarioGog = "checked";
				}
				else
				{
					ocultarJuegosUsuarioGog = null;
				}

				if (string.IsNullOrEmpty(opciones.IndexDRMs) == false)
				{
					drms = JsonSerializer.Deserialize<List<MostrarJuegoDRM>>(opciones.IndexDRMs);
				}

				if (string.IsNullOrEmpty(opciones.IndexCategories) == false)
				{
					categorias = JsonSerializer.Deserialize<List<MostrarJuegoCategoria>>(opciones.IndexCategories);
				}

				#endregion
			}
		}

		//------------------------------------------------

		conexion = Herramientas.BaseDatos.Conectar();

		using (conexion)
		{
			#region Destacados

			if (juegosDestacadosMostrar == null || juegosDestacadosMostrar?.Count == 0)
			{
				List<Juegos.Juego> juegosDestacadosMostrar2 = BaseDatos.Portada.Buscar.Destacados(conexion);

				foreach (var juego in juegosDestacadosMostrar2)
				{
					JuegoMostrar juegoDestacadoMostrar = new JuegoMostrar
					{
						Juego = juego,
						DeseadoImportado = false,
						Color = "var(--fondoBotonPequeño)"
					};

					if (Herramientas.UsuarioJuegos.ComprobarSiTiene(juegosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM) == true)
					{
						juegoDestacadoMostrar.Color = "var(--fondoBien)";
					}
					else
					{
						if (Herramientas.Deseados.ComprobarSiEstaImportado(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
						{
							juegoDestacadoMostrar.Color = "var(--fondoAlerta)";
							juegoDestacadoMostrar.DeseadoImportado = true;
						}
						if (Herramientas.Deseados.ComprobarSiEstaWeb(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
						{
							juegoDestacadoMostrar.Color = "var(--fondoAlerta)";
						}
					}

					if (juegosDestacadosMostrar == null)
					{
						juegosDestacadosMostrar = new List<JuegoMostrar>();
					}

					juegosDestacadosMostrar.Add(juegoDestacadoMostrar);
				}

				if (juegosDestacadosMostrar?.Count > 0)
				{
					posicionMostrarDestacados = 0;
					videoDestacado = null;
				}
			}

			CronometroDestacados();

			#endregion

			#region Noticias

			try
			{
				noticias ??= BaseDatos.Noticias.Buscar.Actuales(tipoSeleccionadoNoticias, 3, conexion);

				if (noticias?.Count > 0)
				{
					foreach (var noticia in noticias)
					{
						bool añadirTipo = true;

						if (tiposActualesNoticias.Count > 0)
						{
							foreach (var tipoActual in tiposActualesNoticias)
							{
								if (tipoActual == noticia.Tipo)
								{
									añadirTipo = false;
								}
							}
						}

						if (añadirTipo == true)
						{
							tiposActualesNoticias.Add(noticia.Tipo);
						}
					}
				}

				if (string.IsNullOrEmpty(usuarioId) == false)
				{
					int limiteTiempoNoticias = 90;

					if (usuarioPatreon == true || usuarioAdmin == true)
					{
						limiteTiempoNoticias = 30;
					}

					CronometroNoticias(limiteTiempoNoticias);
				}
			}
			catch (Exception ex)
			{
				BaseDatos.Errores.Insertar.Mensaje("Portada Noticias", ex);
			}

			#endregion

			#region Minimos

			Filtros(true);

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				int limiteTiempoMinimos = 150;

				if (usuarioPatreon == true || usuarioAdmin == true)
				{
					limiteTiempoMinimos = 30;
				}

				CronometroMinimos(limiteTiempoMinimos);
			}

			#endregion
		}
	}

	protected override async Task OnAfterRenderAsync(bool primerRender)
	{
		if (primerRender == true)
		{
			await ServicioNotificaciones.RequestPermissionAsync();
		}
	}

	private void EnseñarDestacadoVideo(EventArgs args, Juegos.Juego juegoDestacado)
	{
		videoDestacado = null;

		if (juegosDestacadosMostrar[posicionMostrarDestacados].Juego?.Media?.Videos?.Count > 0)
		{
			videoDestacado = juegosDestacadosMostrar[posicionMostrarDestacados].Juego.Media.Videos[0].Micro;
		}
	}

	#region Destacados

	[PersistentState] public List<JuegoMostrar> juegosDestacadosMostrar { get; set; }
	[PersistentState] public int posicionMostrarDestacados { get; set; }

	private PeriodicTimer cronometro = null;
	[PersistentState] public int cronometroContador { get; set; }
	private int cronometroLimite = 30;

	public class JuegoMostrar
	{
		public Juegos.Juego Juego { get; set; }
		public bool DeseadoImportado { get; set; }
		public string Color { get; set; }
		public bool DeseadoMostrar { get; set; }
	}

	private void CambiarJuegoDestacado(MouseEventArgs args, JuegoMostrar destacadoSeleccionado)
	{
		int nuevaPosicion = 0;

		foreach (var destacado in juegosDestacadosMostrar)
		{
			if (destacado == destacadoSeleccionado)
			{
				break;
			}

			nuevaPosicion += 1;
		}

		posicionMostrarDestacados = nuevaPosicion;
		videoDestacado = null;

		cronometroContador = 0;
		cronometro.Dispose();
		CronometroDestacados();
	}

	private async void CronometroDestacados()
	{
		cronometro = new PeriodicTimer(TimeSpan.FromSeconds(1));

		while (await cronometro.WaitForNextTickAsync())
		{
			cronometroContador += 1;

			if (cronometroContador == cronometroLimite || juegosDestacadosMostrar.Count == 0)
			{
				bool tomarSiguiente = false;

				int i = 0;
				foreach (var destacado in juegosDestacadosMostrar)
				{
					if (tomarSiguiente == true)
					{
						posicionMostrarDestacados = posicionMostrarDestacados + 1;
						videoDestacado = null;
						break;
					}

					if (destacado.Juego.IdMaestra == juegosDestacadosMostrar[posicionMostrarDestacados].Juego.IdMaestra)
					{
						tomarSiguiente = true;
					}

					i += 1;
				}

				if (i == juegosDestacadosMostrar.Count)
				{
					juegosDestacadosMostrar.Clear();

					List<Juegos.Juego> juegosDestacadosMostrar2 = BaseDatos.Portada.Buscar.Destacados(conexion);

					if (juegosDestacadosMostrar2?.Count > 0)
					{
						posicionMostrarDestacados = 0;
						videoDestacado = null;
					}

					foreach (var juego in juegosDestacadosMostrar2)
					{
						JuegoMostrar juegoDestacadoMostrar = new JuegoMostrar
						{
							Juego = juego,
							DeseadoImportado = false,
							Color = "var(--fondoBotonPequeño)"
						};

						if (Herramientas.UsuarioJuegos.ComprobarSiTiene(juegosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM) == true)
						{
							juegoDestacadoMostrar.Color = "var(--fondoBien)";
						}
						else
						{
							if (Herramientas.Deseados.ComprobarSiEstaImportado(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
							{
								juegoDestacadoMostrar.Color = "var(--fondoAlerta)";
								juegoDestacadoMostrar.DeseadoImportado = true;
							}

							if (Herramientas.Deseados.ComprobarSiEstaWeb(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
							{
								juegoDestacadoMostrar.Color = "var(--fondoAlerta)";
							}
						}

						juegosDestacadosMostrar.Add(juegoDestacadoMostrar);
					}
				}

				cronometroContador = 0;
			}

			await InvokeAsync(StateHasChanged);
		}
	}

	#endregion

	#region Minimos Lista

	private int cantidadJuegosMinimos = 100;

	private void GenerarListaMinimos(bool cargaInicial = false)
	{
		try
		{
			List<string> categoriasNumeros = new List<string>();

			if (categorias?.Count > 0)
			{
				foreach (var categoria in categorias)
				{
					if (categoria.Estado == true)
					{
						categoriasNumeros.Add(Convert.ChangeType(categoria.Categoria, categoria.Categoria.GetTypeCode()).ToString());
					}
				}
			}

			List<string> drmsNumeros = new List<string>();

			if (drms?.Count > 0)
			{
				foreach (var drm in drms)
				{
					if (drm.Estado == true)
					{
						drmsNumeros.Add(Convert.ChangeType(drm.DRMId, drm.DRMId.GetTypeCode()).ToString());
					}
				}
			}

			if (tipoSeleccionadoMinimos == MinimosTipo.Nuevos)
			{
				if (cargaInicial == false)
				{
					juegosMinimosGestor = BaseDatos.Portada.Buscar.Minimos(0, cantidadJuegosMinimos, categoriasNumeros, drmsNumeros, conexion, 199);
				}
				else
				{
					juegosMinimosGestor ??= BaseDatos.Portada.Buscar.Minimos(0, cantidadJuegosMinimos, categoriasNumeros, drmsNumeros, conexion, 199);
				}				
			}
			else if (tipoSeleccionadoMinimos == MinimosTipo.Populares)
			{
				juegosMinimosGestor = BaseDatos.Portada.Buscar.Minimos(1, cantidadJuegosMinimos, categoriasNumeros, drmsNumeros, conexion, 199);
			}
			else if (tipoSeleccionadoMinimos == MinimosTipo.Lanzamientos)
			{
				juegosMinimosGestor = BaseDatos.Portada.Buscar.Minimos(2, cantidadJuegosMinimos, categoriasNumeros, drmsNumeros, conexion, 49);
			}
			else if (tipoSeleccionadoMinimos == MinimosTipo.Proximamente)
			{
				juegosMinimosGestor = BaseDatos.Portada.Buscar.Proximamente(cantidadJuegosMinimos, categoriasNumeros, drmsNumeros, conexion);
			}
		}
		catch (Exception ex)
		{
			BaseDatos.Errores.Insertar.Mensaje("Portada Minimos", ex);
		}
	}

	private void CargarMasMinimos()
	{
		cantidadJuegosMinimos += 50;

		Filtros();
	}

	private PeriodicTimer cronometroMinimos = null;
	private int cronometroMinimosContador = 0;

	private async void CronometroMinimos(int limite)
	{
		cronometroMinimos = new PeriodicTimer(TimeSpan.FromSeconds(1));

		while (await cronometroMinimos.WaitForNextTickAsync())
		{
			cronometroMinimosContador += 1;

			if (cronometroMinimosContador >= limite)
			{
				Filtros();

				cronometroMinimosContador = 0;
			}

			await InvokeAsync(StateHasChanged);
		}
	}

	private void CambiarTipo(MouseEventArgs e, MinimosTipo nuevoTipo)
	{
		tipoSeleccionadoMinimos = nuevoTipo;

		Filtros();
	}

	private string CambiarEstilo(MinimosTipo nuevoTipo)
	{
		if (nuevoTipo != tipoSeleccionadoMinimos)
		{
			return "background-color: transparent;";
		}
		else
		{
			return "background-color: var(--botonSubcabecera); box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.25),0px 0px 1px 0px rgba(0, 0, 0, 0.25);";
		}
	}

	private string CambiarTexto(MinimosTipo nuevoTipo, string texto)
	{
		if (nuevoTipo == tipoSeleccionadoMinimos)
		{
			return string.Format("{0} {1}", Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Index"), texto);
		}
		else
		{
			return texto;
		}
	}

	#endregion

	#region Minimos Filtrado

	[PersistentState] public List<Juegos.Juego> juegosMinimosGestor { get; set; }
	private List<JuegoMostrar> juegosMinimosMostrar = new List<JuegoMostrar>();
	private MinimosTipo tipoSeleccionadoMinimos = MinimosTipo.Nuevos;

	private enum MinimosTipo
	{
		Nuevos,
		Populares,
		Lanzamientos,
		Proximamente
	}

	private async void Filtros(bool cargaInicial = false)
	{
		GenerarListaMinimos(cargaInicial);

		if (juegosMinimosGestor?.Count > 0)
		{
			juegosMinimosMostrar.Clear();

			foreach (var juego in juegosMinimosGestor)
			{
				bool ocultar = false;

				if (string.IsNullOrEmpty(ocultarJuegosUsuarioSteam) == false)
				{
					if (ocultarJuegosUsuarioSteam == "checked" && juego.PrecioMinimosHistoricos[0].DRM == JuegoDRM.Steam)
					{
						foreach (var juegoUsuario in juegosUsuario.Steam)
						{
							if (juego.IdSteam == juegoUsuario.Id)
							{
								ocultar = true;
								break;
							}
						}
					}
				}

				if (string.IsNullOrEmpty(ocultarJuegosUsuarioGog) == false)
				{
					if (ocultarJuegosUsuarioGog == "checked" && juego.PrecioMinimosHistoricos[0].DRM == JuegoDRM.GOG)
					{
						foreach (var juegoUsuario in juegosUsuario.Gog)
						{
							if (juego.IdGog == juegoUsuario.Id)
							{
								ocultar = true;
								break;
							}
						}
					}
				}

				if (ocultar == false)
				{
					if (juegosMinimosMostrar == null)
					{
						juegosMinimosMostrar = new List<JuegoMostrar>();
					}

					JuegoMostrar juegoMinimoMostrar = new JuegoMostrar
					{
						Juego = juego,
						DeseadoImportado = false,
						Color = "var(--fondoBotonPequeño)",
						DeseadoMostrar = false
					};

					if (Herramientas.UsuarioJuegos.ComprobarSiTiene(juegosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM) == true)
					{
						juegoMinimoMostrar.Color = "var(--fondoBien)";
					}
					else
					{
						if (Herramientas.Deseados.ComprobarSiEstaImportado(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
						{
							juegoMinimoMostrar.Color = "var(--fondoAlerta)";
							juegoMinimoMostrar.DeseadoImportado = true;
						}

						if (Herramientas.Deseados.ComprobarSiEstaWeb(deseadosUsuario, juego, juego.PrecioMinimosHistoricos[0].DRM, true) == true)
						{
							juegoMinimoMostrar.Color = "var(--fondoAlerta)";
						}
					}

					juegosMinimosMostrar.Add(juegoMinimoMostrar);
				}
			}
		}

		if (juegosMinimosMostrar?.Count > 0)
		{
			await InvokeAsync(StateHasChanged);
		}
	}

	private bool mostrarFiltrado = false;

	private void EnseñarFiltrado()
	{
		mostrarFiltrado = true;
	}

	private void OcultarFiltrado()
	{
		mostrarFiltrado = false;
	}

	private string ocultarJuegosUsuarioSteam = null;
	private string ocultarJuegosUsuarioGog = null;

	private void OcultarJuegosUsuarioSteam()
	{
		bool valor = false;

		if (ocultarJuegosUsuarioSteam == "checked")
		{
			ocultarJuegosUsuarioSteam = null;
		}
		else
		{
			ocultarJuegosUsuarioSteam = "checked";
		}

		if (ocultarJuegosUsuarioSteam == "checked")
		{
			valor = true;
		}
		else if (ocultarJuegosUsuarioSteam == null)
		{
			valor = false;
		}

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			BaseDatos.Usuarios.Actualizar.Opcion("IndexOption1", valor, usuarioId, conexion);
		}

		Filtros();
	}

	private void OcultarJuegosUsuarioGog()
	{
		bool valor = false;

		if (ocultarJuegosUsuarioGog == "checked")
		{
			ocultarJuegosUsuarioGog = null;
		}
		else
		{
			ocultarJuegosUsuarioGog = "checked";
		}

		if (ocultarJuegosUsuarioGog == "checked")
		{
			valor = true;
		}
		else if (ocultarJuegosUsuarioGog == null)
		{
			valor = false;
		}

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			BaseDatos.Usuarios.Actualizar.Opcion("IndexOption2", valor, usuarioId, conexion);
		}	

		Filtros();
	}

	private void EnseñarJuegosDRM(ChangeEventArgs e, JuegoDRM drmElegido)
	{
		foreach (var drm in drms)
		{
			if (drm.DRMId == drmElegido)
			{
				if (drm.Checkbox == null)
				{
					drm.Checkbox = "checked";
					drm.Estado = true;
				}
				else
				{
					drm.Checkbox = null;
					drm.Estado = false;
				}
			}
		}

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			BaseDatos.Usuarios.Actualizar.Opcion("IndexDRMs", JsonSerializer.Serialize(drms), usuarioId, conexion);
		}

		Filtros();
	}

	private List<MostrarJuegoDRM> drms = CrearListaDRMs();

	public class MostrarJuegoDRM
	{
		public bool Estado { get; set; }
		public string Checkbox { get; set; }
		public JuegoDRM DRMId { get; set; }
	}

	private static List<MostrarJuegoDRM> CrearListaDRMs()
	{
		List<MostrarJuegoDRM> nuevaLista = new List<MostrarJuegoDRM>();

		foreach (var drm in JuegoDRM2.GenerarListado())
		{
			MostrarJuegoDRM nuevoDRM = new MostrarJuegoDRM();
			nuevoDRM.Estado = false;
			nuevoDRM.Checkbox = null;
			nuevoDRM.DRMId = drm.Id;

			if (nuevoDRM.DRMId == JuegoDRM.Steam || nuevoDRM.DRMId == JuegoDRM.GOG || nuevoDRM.DRMId == JuegoDRM.Ubisoft || nuevoDRM.DRMId == JuegoDRM.EA)
			{
				nuevoDRM.Estado = true;
				nuevoDRM.Checkbox = "checked";
			}

			nuevaLista.Add(nuevoDRM);
		}

		return nuevaLista;
	}

	private void EnseñarJuegosCategoria(ChangeEventArgs e, JuegoTipo categoriaElegida)
	{
		foreach (var categoria in categorias)
		{
			if (categoria.Categoria == categoriaElegida)
			{
				if (categoria.Checkbox == null)
				{
					categoria.Checkbox = "checked";
					categoria.Estado = true;
				}
				else
				{
					categoria.Checkbox = null;
					categoria.Estado = false;
				}
			}
		}

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			BaseDatos.Usuarios.Actualizar.Opcion("IndexCategories", JsonSerializer.Serialize(categorias), usuarioId, conexion);
		}

		Filtros();
	}

	private List<MostrarJuegoCategoria> categorias = CrearListaCategorias();

	public class MostrarJuegoCategoria
	{
		public bool Estado { get; set; }
		public string Checkbox { get; set; }
		public JuegoTipo Categoria { get; set; }
	}

	private static List<MostrarJuegoCategoria> CrearListaCategorias()
	{
		List<MostrarJuegoCategoria> nuevaLista = new List<MostrarJuegoCategoria>();

		foreach (var categoria in JuegoTipos.CargarListado())
		{
			if (categoria != JuegoTipo.Bundle)
			{
				MostrarJuegoCategoria nuevaTienda = new MostrarJuegoCategoria();
				nuevaTienda.Estado = true;
				nuevaTienda.Checkbox = "checked";
				nuevaTienda.Categoria = categoria;

				nuevaLista.Add(nuevaTienda);
			}
		}

		return nuevaLista;
	}

	#endregion

	#region Noticias

	[PersistentState] public List<Noticias.Noticia> noticias { get; set; }

	private PeriodicTimer cronometroNoticias = null;
	private int cronometroNoticiasContador = 0;

	private async void CronometroNoticias(int limite)
	{
		cronometroNoticias = new PeriodicTimer(TimeSpan.FromSeconds(1));

		while (await cronometroNoticias.WaitForNextTickAsync())
		{
			cronometroNoticiasContador += 1;

			if (cronometroNoticiasContador >= limite)
			{
				noticias = BaseDatos.Noticias.Buscar.Actuales(tipoSeleccionadoNoticias, 3, conexion);

				cronometroNoticiasContador = 0;
			}

			await InvokeAsync(StateHasChanged);
		}
	}

	private NoticiaTipo tipoSeleccionadoNoticias = NoticiaTipo.Desconocido;
	private List<NoticiaTipo> tiposActualesNoticias = new List<NoticiaTipo>();

	private void CambiarTipo(MouseEventArgs e, NoticiaTipo nuevoTipo)
	{
		tipoSeleccionadoNoticias = nuevoTipo;
		noticias = BaseDatos.Noticias.Buscar.Actuales(tipoSeleccionadoNoticias, 3, conexion);
	}

	private string CambiarEstilo(NoticiaTipo nuevoTipo)
	{
		if (nuevoTipo != tipoSeleccionadoNoticias)
		{
			return "background-color: transparent;";
		}
		else
		{
			return "background-color: var(--botonSubcabecera); box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.25),0px 0px 1px 0px rgba(0, 0, 0, 0.25);";
		}
	}

	#endregion

	#region Deseados

	private async void CambiarEstadoDeseado(MouseEventArgs e, string usuarioId, JuegoMostrar juego, JuegoDRM drm)
	{
		bool estado = true;

		if (juego.Color == "var(--fondoAlerta)")
		{
			estado = false;
		}

		Herramientas.Deseados.CambiarEstado(usuarioId, juego.Juego, estado, drm, false);

		foreach (var juego2 in juegosDestacadosMostrar)
		{
			if (juego2.Juego.Id == juego.Juego.Id && juego2.Juego.PrecioMinimosHistoricos[0].DRM == drm)
			{
				if (estado == true)
				{
					juego2.Color = "var(--fondoAlerta)";
				}
				else
				{
					juego2.Color = "var(--fondoBotonPequeño)";
				}
			}
		}

		foreach (var juego2 in juegosMinimosMostrar)
		{
			if (juego2.Juego.Id == juego.Juego.Id && juego2.Juego.PrecioMinimosHistoricos[0].DRM == drm)
			{
				if (estado == true)
				{
					juego2.Color = "var(--fondoAlerta)";
				}
				else
				{
					juego2.Color = "var(--fondoBotonPequeño)";
				}
			}
		}

		await InvokeAsync(StateHasChanged);
	}

	private void MostrarBotonDeseados(MouseEventArgs e, JuegoMostrar juego)
	{
		juego.DeseadoMostrar = true;
	}

	private void OcultarBotonDeseados(MouseEventArgs e, JuegoMostrar juego)
	{
		juego.DeseadoMostrar = false;
	}

	#endregion
}
